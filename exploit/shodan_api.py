import shodan
import sys
import re

class shodanApi:
    def __init__(self, query):
        self.query = query
        self.apiKey = "IAH25En7zM5gwU2qB4SbYzqGjAOneJ7V"
        
    def get_Infor(self):
        regexOfDomain = "(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z0-9][a-z0-9-]{0,61}[a-z0-9]"
        regexOfCVE = "CVE-\d{4}-\d{4,7}"

        try:
        # Setup the api
            api = shodan.Shodan(self.apiKey)

            # Perform the search
            query = ' '.join(self.query)
            result = api.search(query)

            # Loop through the matches and print each IP
            for service in result['matches']:

                if str(service["domains"]) == "[]":
                    print("Domain: " )
                else:
                    domainName = re.findall(regexOfDomain,str(service['domains']))
                    print("Domain: ")
                    for i in range(0, len(domainName)):
                        print(domainName[i])

                print("IP: ", service['ip_str'])
                if 'vulns' in service:
                    print("Vuln: ", re.findall(regexOfCVE,str(service['vulns'])))
                else:
                    print("Not have vuln !!!")
                print("==========================")        
        except Exception as e:
                print ('Error: %s' % e)
                sys.exit(1)
            
def main():
    cmd = 'Exchange server country:"VN" port:"443"'
    api = shodanApi(cmd)
    api.get_Infor()

if __name__ == '__main__':
    main()